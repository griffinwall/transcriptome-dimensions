---
title: "Myeloma dimensions and demographic risk groups"
output:
  html_document:
    theme: united
    highlight: tango
params:
    data: "/Users/rosal/OneDrive - University of Utah/2020/analyze/data/transcriptome-dimensions/analysis/20200802_pipe_out.rdata"
---

Code to investigate associations between patient demographics (age, gender, self-reported race and ethnicity) and transcriptome dimensions using analysis of variance.


```{r load_packages, message=F, include=F}
# Install and load required R packages
library(dplyr)
library(data.table)
library(ggplot2)
library(MASS)
library(survivalAnalysis)
```

Load transcriptome dimensions (PC1-PC39)
```{r}
load(file = params$data) # load processed data
```

### 1. Age
```{r}
DAT = merge(clinical[,c("SEQ_ID","D_PT_age")],score_sd) # Select data

lm.age = lm(data = DAT[,-"SEQ_ID"],formula = D_PT_age ~ .)
summary(lm.age)

nsig = data.table(summary(lm.age)$coeff[-1,"Pr(>|t|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Overall p-value
df1 = summary(lm.age)$fstatistic[2]
df2 = summary(lm.age)$fstatistic[3]
f = summary(lm.age)$fstatistic[1]
lm.age$p = pf(f,df1,df2,lower.tail = F) # Compute p-value from f-statistic
```

### 2. Gender
```{r}
DAT = merge(clinical[,c("SEQ_ID","D_PT_gender")],score_sd) # Select data
DAT$D_PT_gender = as.factor(DAT$D_PT_gender)

glm.gender = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_gender ~ .,family = "binomial")
summary(glm.gender)

nsig = data.table(summary(glm.gender)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_gender ~ 1,family = "binomial")

glm.gender$p = pchisq(deviance(NLL)-deviance(glm.gender),
                         df.residual(NLL)-df.residual(glm.gender),
                         lower.tail=FALSE)
```

### 3. Self-reported race
```{r}
merge(clinical,score_sd,by="SEQ_ID") %>% group_by(D_PT_race) %>% count() # count by race
DAT = merge(clinical[clinical$D_PT_race%in%c(1,2),c("SEQ_ID","D_PT_race")],score_sd) # Select data
DAT$D_PT_race = as.factor(DAT$D_PT_race)

glm.race = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_race ~ .,family = "binomial")
summary(glm.race)

nsig = data.table(summary(glm.race)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_race ~ 1,family = "binomial")

glm.race$p = pchisq(deviance(NLL)-deviance(glm.race),
                         df.residual(NLL)-df.residual(glm.race),
                         lower.tail=FALSE)
```

### 4. Self-reported ethnicity
```{r}
merge(clinical,score_sd,by="SEQ_ID") %>% group_by(D_PT_ethnic) %>% count() # count by ethnic
DAT = merge(clinical[clinical$D_PT_ethnic%in%c(1,2),c("SEQ_ID","D_PT_ethnic")],score_sd) # Select data
DAT$D_PT_ethnic = as.factor(DAT$D_PT_ethnic)

glm.ethnic = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_ethnic ~ .,family = "binomial")
summary(glm.ethnic)

nsig = data.table(summary(glm.ethnic)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"],formula = D_PT_ethnic ~ 1,family = "binomial")

glm.ethnic$p = pchisq(deviance(NLL)-deviance(glm.ethnic),
                         df.residual(NLL)-df.residual(glm.ethnic),
                         lower.tail=FALSE)
```
**Save model results**
```{r}
save(lm.age,glm.gender,glm.race,glm.ethnic,file = "rdata/mod.demographic-risk.rdata")
```