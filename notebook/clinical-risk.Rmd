---
title: "Myeloma dimensions and clinical risk"
output:
  html_document:
    theme: united
    highlight: tango
params:
    data: "/Users/rosal/OneDrive - University of Utah/2020/analyze/data/transcriptome-dimensions/analysis/20200802_pipe_out.rdata"
---

```{r load_packages, message=F, include=F}
# Install and load required R packages
library(dplyr)
library(data.table)
library(ggplot2)
library(MASS)
library(survivalAnalysis)
library("lmtest")
```

Load transcriptome dimensions (PC1-PC)
```{r}
load(file = params$data) # load processed data
setwd("C:/Users/rosal/github/transcriptome-dimensions/notebook")
```

### 1. Cytogenetics
Large somatic chromosomal DNA aberrations detected by cytogenetics are used to define prognostic risk groups in myeloma. Clinical risk categories defined by mSMART7 include: high risk, del(17p) and t(14;16); intermediate risk, amp(1q) and t(4;14); and standard risk, t(11;14). 

1.1. del(17p): D_TRI_CF_ABNORMALITYPR11 & D_TRI_CF_17PABNORMALCE (abundance)
```{r}
DAT = merge(clinical[clinical$D_TRI_CF_ABNORMALITYPR11!="Not Done" & clinical$D_TRI_CF_ABNORMALITYPR11!="",
                     c("SEQ_ID","D_TRI_CF_ABNORMALITYPR11")],score_sd)
print(paste("Baseline samples with data:",nrow(DAT),"(total),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR11=="Yes"]),"(+),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR11=="No"]),"(-)"))
DAT$D_TRI_CF_ABNORMALITYPR11 = as.factor(DAT$D_TRI_CF_ABNORMALITYPR11)

# Logistic regression
md.dt = DAT[,-"SEQ_ID"]
MOD = glm(data = md.dt, formula = D_TRI_CF_ABNORMALITYPR11 ~ ., family = "binomial")
summary(MOD)

# Count number of significant spectra
nsig = data.table(summary(MOD)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = list(d17p=MOD)

# Overall p-value
NLL = glm(data = md.dt, formula = D_TRI_CF_ABNORMALITYPR11 ~ 1, family = "binomial")

mod.risk$d17p$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```

1.2. t(14;16): D_TRI_CF_ABNORMALITYPR8 & D_TRI_CF_T1416ABNORMAL (abundance)
```{r}
DAT = merge(clinical[clinical$D_TRI_CF_ABNORMALITYPR8!="Not Done" & clinical$D_TRI_CF_ABNORMALITYPR8!="",
                     c("SEQ_ID","D_TRI_CF_ABNORMALITYPR8")],score_sd)
print(paste("Baseline samples with data:",nrow(DAT),"(total),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR8=="Yes"]),"(+),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR8=="No"]),"(-)"))
DAT$D_TRI_CF_ABNORMALITYPR8 = as.factor(DAT$D_TRI_CF_ABNORMALITYPR8)

# Logistic regression
MOD <- glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR8 ~ ., family = "binomial")
summary(MOD)
nsig = data.table(summary(MOD)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = c(mod.risk,list(t1416=MOD))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR8 ~ 1, family = "binomial")

mod.risk$t1416$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```


1.3. amp(1q): D_TRI_CF_ABNORMALITYPR13 & D_TRI_CF_1PAMPLIFICATI2 (abundance)
```{r}
DAT = merge(clinical[clinical$D_TRI_CF_ABNORMALITYPR13!="Not Done" & clinical$D_TRI_CF_ABNORMALITYPR13!="",
                     c("SEQ_ID","D_TRI_CF_ABNORMALITYPR13")],score_sd)
print(paste("Baseline samples with data:",nrow(DAT),"(total),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR13=="Yes"]),"(+),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR13=="No"]),"(-)"))
DAT$D_TRI_CF_ABNORMALITYPR13 = as.factor(DAT$D_TRI_CF_ABNORMALITYPR13)

# Logistic regression
MOD <- glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR13 ~ ., family = "binomial")
summary(MOD)
nsig = data.table(summary(MOD)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = c(mod.risk,list(a1q=MOD))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR13 ~ 1, family = "binomial")

mod.risk$a1q$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```


1.4. t(4;14): D_TRI_CF_ABNORMALITYPR3 & D_TRI_CF_T414ABNORMALC (abundance)
```{r}
DAT = merge(clinical[clinical$D_TRI_CF_ABNORMALITYPR3!="Not Done" & clinical$D_TRI_CF_ABNORMALITYPR3!="",
                     c("SEQ_ID","D_TRI_CF_ABNORMALITYPR3")],score_sd)
print(paste("Baseline samples with data:",nrow(DAT),"(total),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR3=="Yes"]),"(+),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR3=="No"]),"(-)"))
DAT$D_TRI_CF_ABNORMALITYPR3 = as.factor(DAT$D_TRI_CF_ABNORMALITYPR3)

# Logistic regression
MOD <- glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR3 ~ ., family = "binomial")
summary(MOD)
nsig = data.table(summary(MOD)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = c(mod.risk,list(t414=MOD))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR3 ~ 1, family = "binomial")

mod.risk$t414$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```

1.5. t(11;14): D_TRI_CF_ABNORMALITYPR6 & D_TRI_CF_T1114ABNORMAL (abundance)
```{r}
DAT = merge(clinical[clinical$D_TRI_CF_ABNORMALITYPR6!="Not Done" & clinical$D_TRI_CF_ABNORMALITYPR6!="",
                     c("SEQ_ID","D_TRI_CF_ABNORMALITYPR6")],score_sd)
print(paste("Baseline samples with data:",nrow(DAT),"(total),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR6=="Yes"]),"(+),",nrow(DAT[DAT$D_TRI_CF_ABNORMALITYPR6=="No"]),"(-)"))
DAT$D_TRI_CF_ABNORMALITYPR6 = as.factor(DAT$D_TRI_CF_ABNORMALITYPR6)

# Logistic regression
MOD <- glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR6 ~ ., family = "binomial")
summary(MOD)
nsig = data.table(summary(MOD)$coeff[-1,"Pr(>|z|)"]) %>% subset(V1<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = c(mod.risk,list(t1114=MOD))

# Overall p-value
NLL = glm(data = DAT[,-"SEQ_ID"], formula = D_TRI_CF_ABNORMALITYPR6 ~ 1, family = "binomial")

mod.risk$t1114$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```


### 2. International staging system (ISS)
2.1. RUN LOGISTIC REGRESSION
```{r}
DAT = merge(clinical[!is.na(clinical$D_PT_iss),c("SEQ_ID","D_PT_iss")],score_sd) # Remove samples with missing ISS values
print(paste("Baseline samples with ISS score =",nrow(DAT)))
#DAT$ISS = as.factor(DAT$D_PT_iss)
# Logistic regression
#glm.iss <- glm(data = DAT[,-c("SEQ_ID","D_PT_iss")], formula = ISS ~ ., family = "binomial")
#summary(glm.iss)

DAT$ISS = factor(DAT$D_PT_iss, levels = c(1,2,3), ordered = TRUE) # Order dependent variable
MOD = polr(data = DAT[,-c("SEQ_ID","D_PT_iss")], formula = ISS ~ ., Hess = T) # Ordinal logistic regression model
summary(MOD)
sig = pnorm(abs(coef(summary(MOD))[1:39,"t value"]),lower.tail = FALSE)*2
nsig = data.table(sig) %>% subset(sig<0.05) %>% nrow() # Count sig dimensions in model
print(paste0(nsig," of the ",ncol(score_sd)-1," dimensions were significat at p < 0.05 in the combined model"))

# Save model
mod.risk = c(mod.risk,list(iss=MOD))

# Overall p-value
NLL = polr(data = DAT[,-c("SEQ_ID","D_PT_iss")], formula = ISS ~ 1, Hess = T)

mod.risk$iss$p = pchisq(deviance(NLL)-deviance(MOD),
                         df.residual(NLL)-df.residual(MOD),
                         lower.tail=FALSE)
```
**Save model results**
```{r}
save(mod.risk,file = "rdata/mod.clinical-risk.rdata")
```
